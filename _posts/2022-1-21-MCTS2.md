---
layout: post
title: 'åˆ©ç”¨è’™ç‰¹å¡æ´›æ ‘æœç´¢å®ç°äº”å­æ£‹æ¸¸æˆåŠŸèƒ½ï¼ˆäºŒï¼‰'
date: 2022-1-21
author: ä¸æ˜¾ç”µæ€§
cover: 'http://commcheck396.github.io/blog/assets/img/2022_1_19/topic1.jpg'
tags: ML Python
---

> ### æœ¬åŠŸèƒ½åˆ©ç”¨Pythonè¯­è¨€ï¼ŒåŸºäºnumpyåº“å®ç°  


## è’™ç‰¹å¡æ´›æ ‘æœç´¢   

è¦åˆ©ç”¨è’™ç‰¹å¡æ´›æ ‘å¯¹å¯¹äº”å­æ£‹æ£‹å±€è¿›è¡Œæœç´¢ï¼Œé¦–å…ˆè¦äº†è§£è’™ç‰¹å¡æ´›æ ‘æœç´¢çš„è¿‡ç¨‹ã€‚  <br/>
ä¸€èˆ¬æ¥è¯´ï¼Œè’™ç‰¹å¡æ´›æ ‘çš„æœç´¢è¿‡ç¨‹åˆ†ä¸ºå››æ­¥ï¼Œåˆ†åˆ«æ˜¯é€‰æ‹©ï¼ˆSelectionï¼‰ï¼Œæ‰©å±•ï¼ˆExpansionï¼‰ï¼Œä»¿çœŸï¼ˆSimulationï¼‰å’Œåå‘ä¼ æ’­ï¼ˆBackpropagationï¼‰ï¼Œè¦èƒ½è®©è¿™äº›æ“ä½œé¡ºåˆ©åœ°è¿è½¬èµ·æ¥ï¼Œæˆ‘ä»¬é¦–å…ˆéœ€è¦ä¸€ä¸ªæ ‘å½¢æ•°æ®ç»“æ„ï¼Œå§‘ä¸”å«å®ƒæ¸¸æˆæ ‘ã€‚<br/>
è¦å®ç°æ ‘å½¢ç»“æ„ï¼Œé¦–å…ˆè¦å®šä¹‰èŠ‚ç‚¹çš„æ•°æ®ç»“æ„ï¼Œæ–°å»ºä¸€ä¸ªèŠ‚ç‚¹ç±»å‹`Class Node`ï¼Œä»£è¡¨ä¸€ä¸ªæ£‹ç›˜æ ¼å±€ï¼Œå…¶å±æ€§åˆ†åˆ«æœ‰:<br/>
`board`æ£‹ç›˜æ ¼å±€ï¼Œ<br/>
`pre_pos`æœ€åä¸€æ¬¡è½å­çš„ä½ç½®ï¼Œ<br/>
`parent`çˆ¶èŠ‚ç‚¹ï¼Œ<br/>
`children`æ‰€æœ‰çš„å­èŠ‚ç‚¹ï¼Œ<br/>
`not_vistit_pos`æœªè®¿é—®çš„ç»“ç‚¹ï¼Œ<br/>
`num_visit`è¯¥èŠ‚ç‚¹è¢«è®¿é—®çš„æ¬¡æ•°ï¼Œ<br/>
`num_of_wins`è¯¥èŠ‚ç‚¹ä»¿çœŸè¿‡ç¨‹ä¸­é»‘å­å’Œç™½å­çš„èƒœåˆ©æ¬¡æ•°ï¼Œ<br/>
å±æ€§å®šä¹‰ä»¥åŠåˆå§‹åŒ–å¦‚ä¸‹ï¼š<br/>
```python
def __init__(self, parent=None, pre_pos=None, board=None):
    self.pre_pos = pre_pos 
    self.parent = parent  
    self.children = list()
    self.not_visit_pos = None
    self.board = board
    self.num_of_visit = 0 
    self.num_of_wins = defaultdict(int)     # è®°å½•è¯¥ç»“ç‚¹æ¨¡æ‹Ÿçš„ç™½å­ã€é»‘å­çš„èƒœåˆ©æ¬¡æ•°(defaultdict: å½“å­—å…¸é‡Œçš„keyä¸å­˜åœ¨ä½†è¢«æŸ¥æ‰¾æ—¶ï¼Œè¿”å›0)
```

<br/>

ä»…æœ‰æ•°æ®ç»“æ„æ˜¯è¿œè¿œä¸å¤Ÿçš„ï¼Œè¿˜éœ€è¦å®šä¹‰ä¸€å¥—åŠ¨ä½œæ¥å®ç°è¿™äº›è¿‡ç¨‹ï¼š<br/>
`fully_expanded(self)`ï¼šåˆ¤æ–­ç»“ç‚¹æ˜¯å¦å®Œå…¨æ‰©å±•ã€‚<br/>
`non_terminal(self)`ï¼šåˆ¤æ–­ç»“ç‚¹æ˜¯å¦ä¸ºç»ˆç«¯å¶å­ç»“ç‚¹ï¼Œå³è¯¥èŠ‚ç‚¹å¯¹åº”çš„æ ¼å±€æ˜¯å¦å·²åˆ†å‡ºèƒœè´Ÿã€‚<br/>
`pick_univisted(self)`ï¼šé€‰æ‹©ä¸€ä¸ªæœªè®¿é—®çš„ç»“ç‚¹å¹¶å°†å…¶æ·»åŠ è¿›å½“å‰ç»“ç‚¹çš„å­©å­ä¸­ã€‚<br/>
`pick_random(self)`ï¼šéšæœºé€‰æ‹©è¯¥èŠ‚ç‚¹çš„ä¸€ä¸ªå­©å­è¿›è¡Œæ‰©å±•ã€‚<br/>
`num_of_win(self)`ï¼šåˆ¤æ–­è¯¥èŠ‚ç‚¹çš„èƒœè´Ÿæƒ…å†µï¼Œåˆ©ç”¨ä¸€ä¸ªå®æ•°å³å¯ä»£è¡¨é»‘ç™½äºŒå­çš„èƒœè´Ÿå·®å€¼ã€‚<br/>
`best_uct(self, c_param=1.98)`ï¼šUCTæ¯”è¾ƒè¿‡ç¨‹ï¼Œé€‰æ‹©å½“å‰ç­–ç•¥ä¸‹æœ€ä¼˜çš„å­©å­ç»“ç‚¹ï¼Œå¯è°ƒèŠ‚å‚æ•°ï¼Œä¾æ®çš„å…¬å¼ä¸º:<br/>
```math
\frac{w_i}{n_i} + c \sqrt{\frac{ln t}{n_i}} 

```
```math
w_{i}ä»£è¡¨ç¬¬iæ¬¡ç§»åŠ¨åå–èƒœçš„æ¬¡æ•°ï¼›

```

```math
n_iä»£è¡¨ç¬¬iæ¬¡ç§»åŠ¨åä»¿çœŸçš„æ¬¡æ•°ï¼›
```

```math
cä¸ºæ¢ç´¢å‚æ•°â€”ç†è®ºä¸Šç­‰äº\sqrt {2}ï¼›åœ¨å®é™…ä¸­é€šå¸¸å¯å‡­ç»éªŒé€‰æ‹©ï¼›
```

```math
tä»£è¡¨ä»¿çœŸæ€»æ¬¡æ•°ï¼Œç­‰äºæ‰€æœ‰n_içš„å’Œã€‚
```




<br/><br/>

*å‡½æ•°ä»£ç é™„åœ¨åšå®¢ç»“å°¾å¤„ã€‚*

<br/>

æ¥ä¸‹æ¥å°±å¯ä»¥åŸºäºè¿™äº›çš„åŠ¨ä½œï¼Œç€æ‰‹è¿›è¡Œè’™ç‰¹å¡æ´›æ ‘æœç´¢çš„ç¼–å†™äº†ã€‚  
### é€‰æ‹©ï¼ˆSelectionï¼‰
é€‰æ‹©æ“ä½œï¼Œå³ä»æ ¹èŠ‚ç‚¹Rå¼€å§‹ï¼Œè¿ç»­å‘ä¸‹é€‰æ‹©å­èŠ‚ç‚¹è‡³å¶å­èŠ‚ç‚¹Lã€‚åˆ©ç”¨`best_uct`æ–¹æ³•ï¼Œè®©æ¸¸æˆæ ‘å‘æœ€ä¼˜çš„æ–¹å‘æ‰©å±•ï¼Œè¿™æ˜¯è’™ç‰¹å¡æ´›æ ‘æœç´¢çš„ç²¾è¦æ‰€åœ¨ã€‚ <br/> 
è¿™ä¸€æ­¥çš„æ“ä½œå¦‚å›¾æ‰€ç¤ºï¼ˆç®­å¤´ä»£è¡¨è¿™ä¸€æ­¥çš„æ“ä½œï¼‰ï¼š

![pic from internet](http://commcheck396.github.io/blog/assets/img/2022_1_20/selection.svg.png)

### æ‰©å±•ï¼ˆExpansionï¼‰
æ‰©å±•æ“ä½œï¼Œå³é™¤éä»»æ„ä¸€æ–¹çš„è¾“èµ¢ä½¿å¾—æ¸¸æˆåœ¨Lç»“æŸï¼Œå¦åˆ™åˆ›å»ºä¸€ä¸ªæˆ–å¤šä¸ªå­èŠ‚ç‚¹å¹¶é€‰å–å…¶ä¸­ä¸€ä¸ªèŠ‚ç‚¹Cã€‚  <br/>
è¿™ä¸€æ­¥çš„æ“ä½œå¦‚å›¾æ‰€ç¤ºï¼ˆç®­å¤´ä»£è¡¨è¿™ä¸€æ­¥çš„æ“ä½œï¼‰ï¼š

![pic from internet](http://commcheck396.github.io/blog/assets/img/2022_1_20/expansion.svg.png)

### ä»¿çœŸï¼ˆSimulationï¼‰
ä»¿çœŸæ“ä½œï¼Œå³åœ¨ä»èŠ‚ç‚¹Cå¼€å§‹ï¼Œç”¨éšæœºç­–ç•¥è¿›è¡Œæ¸¸æˆï¼Œåˆç§°ä¸ºplayoutæˆ–è€…rolloutï¼Œç›´è‡³æ ¼å±€è¾¾åˆ°ç»ˆç›˜ï¼Œæ¸¸æˆç»“æŸï¼Œäº§ç”Ÿèƒœè´Ÿã€‚<br/>
è¿™ä¸€æ­¥çš„æ“ä½œå¦‚å›¾æ‰€ç¤ºï¼ˆç®­å¤´ä»£è¡¨è¿™ä¸€æ­¥çš„æ“ä½œï¼‰ï¼š

![pic from internet](http://commcheck396.github.io/blog/assets/img/2022_1_20/simulation.svg.png)

### åå‘ä¼ æ’­ï¼ˆBackpropagationï¼‰
åå‘ä¼ æ’­æ“ä½œï¼Œå³ä½¿ç”¨ä¸Šä¸€æ­¥ä»¿çœŸéšæœºæ¸¸æˆçš„ç»“æœï¼Œæ›´æ–°ä»Cåˆ°Rçš„è·¯å¾„ä¸Šçš„èŠ‚ç‚¹ä¿¡æ¯ï¼Œæ›´æ–°æ¯ä¸ªç»“ç‚¹çš„èƒœè´Ÿå€¼ä»¥åŠæ€»ç›˜æ•°ã€‚<br/>
è¿™ä¸€æ­¥çš„æ“ä½œå¦‚å›¾æ‰€ç¤ºï¼ˆç®­å¤´ä»£è¡¨è¿™ä¸€æ­¥çš„æ“ä½œï¼‰ï¼š

![pic from internet](http://commcheck396.github.io/blog/assets/img/2022_1_20/backpropagation.svg.png)


*æ’å›¾ä¸­èŠ‚ç‚¹å†…çš„å†…å®¹ä»£è¡¨èƒœåˆ©æ¬¡æ•°/æ¸¸æˆæ¬¡æ•°ï¼Œæˆ‘ä»¬å°†åˆ©ç”¨è¿™ä¸ªå‚æ•°æ¥å¯»æ‰¾ä¸‹ä¸€æ­¥çš„æœ€ä¼˜çš„è¡Œæ£‹ä½ç½®ã€‚*

<br/>

æ ¹æ®ä¸Šè¿°å››ä¸ªæ­¥éª¤ï¼Œç¼–å†™å‡½æ•°å®ç°è¯¥åŠŸèƒ½ï¼š<br/>
`traverse(node)`ï¼šéå†ç»“ç‚¹ï¼Œé‡åˆ°å·²å®Œå…¨å±•å¼€çš„ç»“ç‚¹ï¼Œåˆ©ç”¨`best_uct`é€‰æ‹©æœ€ä½³çš„å­©å­èŠ‚ç‚¹ç»§ç»­å‘ä¸‹éå†ã€‚æ­¤å‡½æ•°å®ç°é€‰æ‹©+æ‹“å±•è¿‡ç¨‹ã€‚<br/>
`rollout(node)`ï¼šä»¿çœŸè¿‡ç¨‹ï¼Œä¸æ–­åˆ©ç”¨`pick_random()`éšæœºé€‰æ‹©ç»“ç‚¹ï¼Œç›´è‡³å†³å‡ºèƒœè´Ÿï¼Œè¿”å›èƒœè´Ÿå€¼ã€‚<br/>
`backpropagate(node, result)`ï¼šåå‘ä¼ æ’­è¿‡ç¨‹ï¼Œåˆ©ç”¨`rollout()`çš„ç»“æœå‘ä¸Šæ›´æ–°èŠ‚ç‚¹å†…å®¹ã€‚<br/>
`best_child(node)`ï¼šåˆ©ç”¨æ¯ä¸ªèŠ‚ç‚¹çš„å‚æ•°ï¼ˆèƒœåˆ©æ¬¡æ•°/æ¸¸æˆæ¬¡æ•°ï¼‰æ¥åˆ¤æ–­å“ªä¸€ä¸ªå­©å­æ”¶ç›Šæœ€å¤§ï¼Œå¹¶è¿”å›è¿™ä¸ªå­©å­ã€‚<br/>
`monte_carlo_tree_search(board, pre_pos)`ï¼šåˆ©ç”¨ä¸Šæ–¹åŠŸèƒ½ï¼Œå®ç°è’™ç‰¹å¡æ´›æœç´¢ï¼Œé€‰å‡ºæœ€ä¼˜è½å­ä½ç½®ã€‚<br/>

<br>

*å‡½æ•°ä»£ç é™„åœ¨åšå®¢ç»“å°¾å¤„ã€‚*

è‡³æ­¤ï¼Œæˆ‘ä»¬å·²ç»å®ç°äº†æœ€åŸºç¡€çš„è’™ç‰¹å¡æ´›æ ‘æœç´¢åŠŸèƒ½ï¼Œæ¥ä¸‹æ¥å°±æ˜¯ç”¨æˆ·äº¤äº’ç•Œé¢çš„ç¼–å†™ï¼Œè¿™ä¸€éƒ¨åˆ†å·²ç»ä¸ç®—æ³•æ— å…³ï¼Œä»…éœ€ä¸æ–­è·å–ç”¨æˆ·çš„è½å­ä½ç½®ï¼Œå¹¶é’ˆå¯¹æ¯ä¸€ä¸ªæ£‹ç›˜æ ¼å±€ï¼Œå‡è®¾ç”¨æˆ·ä¼šé€‰æ‹©æœ€æœ‰åˆ©çš„ä½ç½®ï¼Œå¯¹æ¨¡å‹è¿›è¡Œä¸€å®šæ¬¡æ•°çš„è®­ç»ƒï¼Œé’ˆå¯¹è®­ç»ƒç»“æœè®©ç”µè„‘é€‰æ‹©æœ€ä½³çš„è½å­ä½ç½®ã€‚  <br/>
ç»åˆæ­¥æµ‹è¯•ï¼Œåœ¨6\*6æ£‹ç›˜ä¸Šï¼Œæ¯è½®ç»15000æ¬¡æœç´¢åå¾—åˆ°çš„ç»“æœè¿˜ä¸é”™ï¼Œ~~èµ·ç ä¸€æ—¶åŠä¼šä¸ä¼šè¾“ğŸ˜‚~~ã€‚ä½†åœ¨8\*8çš„æ£‹ç›˜ä¸Šï¼Œ15000çš„æœç´¢é‡å°±æ˜¾å¾—æœ‰äº›æ‰è¥Ÿè§è‚˜ï¼Œç»“æœä¸æ€ä¹ˆç†æƒ³ã€‚ä½†å—é™äºç”µè„‘ç®—åŠ›ï¼Œæˆ‘ä¹Ÿä¸çŸ¥é“æ€ä¹ˆç”¨GPUå¯¹è¿™ä¸ªç¨‹åºè¿›è¡Œè¿ç®—ï¼Œå†åŠ å¤§æœç´¢é‡ï¼Œæ¯æ¬¡è¡Œæ£‹éƒ½è¦ç­‰å¾…å¥½é•¿æ—¶é—´ï¼Œç›®å‰å°±å…ˆè¿™æ ·å§ï¼Œå…³äºç”¨æˆ·äº¤äº’çš„éƒ¨åˆ†æ”¾åˆ°ä¸‹ä¸€ç¯‡åšå®¢å§ï¼Œ~~æœ‰æ—¶é—´å°±å†™ä¸€ä¸ªGUIğŸ¥±~~ã€‚

**å›¾ç‰‡æ¥è‡ªÂ©ç»´åŸºç™¾ç§‘*

<br/><br/><br/><br/>
### å‚è€ƒä»£ç ï¼š
ç»“ç‚¹éƒ¨åˆ†ï¼š

```python
def fully_expanded(self):
    if self.not_visit_pos is None:     
        self.not_visit_pos = self.board.get_legal_pos()    
    return True if (len(self.not_visit_pos) == 0 and len(self.children) != 0) else False

def pick_univisted(self):
    random_index = randint(0, len(self.not_visit_pos) - 1)    
    move_pos = self.not_visit_pos.pop(random_index)  


    new_board = self.board.move(move_pos)  
    new_node = TreeNode(parent=self, pre_pos=move_pos, board=new_board) 
    self.children.append(new_node)
    return new_node

def pick_random(self):
    possible_moves = self.board.get_legal_pos()  
    random_index = randint(0, len(possible_moves) - 1)   
    move_pos = possible_moves[random_index]

    new_board = self.board.move(move_pos)
    new_node = TreeNode(parent=self, pre_pos=move_pos, board=new_board)  
    return new_node

def non_terminal(self):
    game_result = self.board.game_over(self.pre_pos)
    return game_result

def num_of_win(self):
    wins = self.num_of_wins[-self.board.cur_player] 
    loses = self.num_of_wins[self.board.cur_player]
    return wins - loses

def best_uct(self, c_param=1.98):
    uct_of_children = np.array(list([
        (child.num_of_win() / child.num_of_visit) + c_param * np.sqrt(np.log(self.num_of_visit) / child.num_of_visit)
        for child in self.children
    ]))
    best_index = np.argmax(uct_of_children)
    return self.children[best_index]
```




è’™ç‰¹å¡æ´›æ ‘æœç´¢éƒ¨åˆ†ï¼š
```python

def monte_carlo_tree_search(board, pre_pos):
    root = TreeNode(board=board, pre_pos=pre_pos)  
    for i in range(0,mcts_times):  
        leaf = traverse(root) 
        simulation_result = rollout(leaf) 
        backpropagate(leaf, simulation_result)  
    return best_child(root).pre_pos


def traverse(node):
    while node.fully_expanded():  
        node = node.best_uct()
    if node.non_terminal() is not None:    
        return node
    else:    
        return node.pick_univisted()   


def rollout(node):
    while True:
        game_result = node.non_terminal()
        if game_result is None:  
            node = node.pick_random() 
        else: 
            break
    if game_result == 'win' and -node.board.cur_player == 1: 
        return 1     
    elif game_result == 'win':    
        return -1   
    else: 
        return 0


def backpropagate(node, result):
    node.num_of_visit += 1
    node.num_of_wins[result] += 1
    if node.parent: 
        backpropagate(node.parent, result)


def best_child(node):
    visit_num_of_children = np.array(list([child.num_of_visit for child in node.children]))
    best_index = np.argmax(visit_num_of_children)
    node = node.children[best_index]
    return node

```
