---
layout: post
title: 'æœ‰å…³é™æ€ç½‘é¡µçˆ¬è™«çš„ç®€ä»‹'
date: 2022-1-19
author: ä¸æ˜¾ç”µæ€§
cover: 'http://commcheck396.github.io/assets/img/2022_1_19/topic1.jpg'
tags: çˆ¬è™« Python
---

> æœ¬åŠŸèƒ½åˆ©ç”¨Pythonè¯­è¨€ï¼ŒåŸºäºBeautifulSoupï¼Œreï¼Œurilibï¼Œxlwtåº“å®ç°ã€‚æŸäº›é¡µé¢éœ€è¦å€ŸåŠ©gzipï¼Œioç­‰åº“è¿›è¡Œå¤„ç†ï¼Œæ‰èƒ½æ­£å¸¸æ‹‰å–ç½‘é¡µæºç ã€‚

<br/>

è°ˆèµ·Pythonå­¦ä¹ ï¼Œçˆ¬è™«çš„ç¼–å†™æ˜¯ä¸€ä¸ªå¾ˆä¸é”™çš„å…¥é—¨é€‰æ‹©ï¼Œæµç¨‹è¾ƒçŸ­ä¸”æˆæ•ˆè¾ƒå¿«ã€‚ä»Šå¤©å°±~~ä»‹ç»~~è®°å½•ä¸€ä¸‹å¦‚ä½•åˆ©ç”¨Pythonè¿›è¡Œé™æ€ç½‘é¡µçš„çˆ¬å–ã€‚å†™è¿™ä¸ªä¸æ˜¯ä¸ºäº†æ•™ä¼šä½ ï¼Œåªæ˜¯ä¸ºäº†è®°å½•ä¸€ä¸‹è¿™ä¸¤å¤©çš„codingï¼Œå…å¾—å¿˜è®°äº†ï¼Œæˆ‘è‡ªå·±éƒ½æ²¡å®Œå…¨ææ˜ç™½ï¼Œä½•è°ˆæ•™ä½ ğŸ˜‚ã€‚
<br/>
~~å†™çˆ¬è™«æœ¬æ¥æ˜¯æƒ³çˆ¬å–ä¸€ä¸‹ä»Šå¹´çš„Bilibiliç™¾å¤§Upä¸»çš„ä¿¡æ¯ï¼Œå†™å®Œæ‰å‘ç°ä»…ä»…åŸºäºé™æ€çˆ¬å–æ ¹æœ¬æ— æ³•å®ç°ğŸ˜­~~
åç»­æˆ‘ä¹Ÿä¼šè¡¥ä¸€ç¯‡å¦‚ä½•è¿›è¡ŒåŠ¨æ€ç½‘é¡µçˆ¬å–çš„åšå®¢ï¼Œè®°å½•ä¸€ä¸‹æˆ‘æ˜¯å¦‚ä½•çˆ¬å–Bilibiliç™¾å¤§Upä¸»çš„ä¿¡æ¯çš„ã€‚
é—²è¯å°‘è°ˆï¼Œè¿›å…¥æ­£é¢˜ã€‚

<br/>
### urllibåº“çš„ä½œç”¨
**urllibåº“**çš„ä½œç”¨ä¸»è¦æ˜¯æ‹‰å–ç½‘é¡µæºç ï¼Œè·å–ç½‘é¡µåŸå§‹æ•°æ®ï¼Œåœ¨çˆ¬è™«ä¸­ä¸»è¦ä½¿ç”¨çš„å‘½ä»¤æ˜¯`urllib.request`ä¸­çš„`openurl`ä»¥åŠ`Request`ï¼Œè‡³äº`urllib.error`ï¼Œä»…ä»…æ˜¯å¯¹ç½‘é¡µå¼‚å¸¸çŠ¶æ€è¿›è¡Œåˆ¤æ–­ï¼Œä½œç”¨ä¸å¤§ï¼Œä»…ä½œäº†è§£ã€‚
<br/>
**`urllib.request.urlopen(request)`**:æŒ‰ç…§requestå°è£…çš„è¯·æ±‚æ‰“å¼€ç½‘é¡µï¼Œè·å–ç½‘é¡µæºç ï¼Œrequestå¯ä»¥ä»…ä»…æ˜¯ä¸€ä¸ªurlï¼Œä¹Ÿå¯ä»¥æ˜¯å°è£…äº†è®¸å¤šä¿¡æ¯çš„ä¸€ä¸ªè¯·æ±‚ï¼Œå¯¹äºä¸€äº›è¾ƒä¸ºå¼€æ”¾çš„ç½‘ç«™æ¯”å¦‚ç™¾åº¦ç­‰æˆ‘ä»¬å¯ä»¥ç›´æ¥åˆ©ç”¨è£¸urlè¿›è¡Œæ‹‰å–ï¼Œè€Œå¯¹äºè±†ç“£ä¸€ç±»ç¨ä½œåçˆ¬çš„ç½‘ç«™ï¼Œåˆ™éœ€è¦åœ¨requestè¯·æ±‚ä¸­å°è£…headersï¼Œæ¯”å¦‚user-agentç­‰è¿›è¡Œè®¿é—®ï¼Œå¦åˆ™ä¼šæŠ¥418ã€‚~~ä½ å°±æ˜¯ä¸ªæ¯å…·~~


![pic from internet](http://commcheck396.github.io/assets/img/2022_1_19/pic3.jpg)
<br>

æ³¨æ„åˆ©ç”¨`urllib.request.urlopen(request)`æ—¶ï¼Œè‹¥æƒ³ä»¥äººç±»å¯ä»¥ç†è§£çš„è¯­è¨€æŸ¥çœ‹ï¼Œè¿˜éœ€å¯¹å…¶åˆ©ç”¨UTF-8è§£ç æ¨¡å¼è¿›è¡Œè§£ç ï¼Œå³`.read().decode('UTF-8')`,è¿™æ ·å³å¯è·å¾—äººç±»å¯ä»¥åˆ†æçš„ç½‘é¡µæºç ã€‚
<br/>
**å°æ’æ›²**ï¼šä¸çŸ¥æ˜¯ä¸æ˜¯VSCodeçš„ç»ˆç«¯æœ‰ä½æ•°é™åˆ¶ï¼Œæˆ‘æ€»æ˜¯æ— æ³•åœ¨ç»ˆç«¯ä¸­printå‡ºæ‰€æœ‰æºç ï¼Œé’ˆå¯¹è¿™ç§æƒ…å†µï¼Œæˆ‘ç›´æ¥åˆ©ç”¨æ–‡ä»¶è¯»å†™æ“ä½œå°†è·å¾—çš„æºç å†™å…¥testæ–‡ä»¶ä¸­ï¼Œè§£å†³äº†è¿™ä¸ªé—®é¢˜ï¼Œä¸ºæ­¤æˆ‘è¿˜å»é‡æ–°å­¦äº†ä¸€ä¸‹Pythonçš„æ–‡ä»¶è¯»å†™æ“ä½œğŸ¤£ã€‚~~How poor my Python is.~~<br/>
åœ¨è¿™ä¸€æ­¥æ“ä½œä¸­è¿˜å¯èƒ½å‡ºç°æ— æ³•è§£ç ç­‰é”™è¯¯ï¼Œå¯èƒ½ä¼šå‡ºç°æ­¤ç±»æŠ¥é”™ï¼š<br/>`UnicodeDecodeError: 'utf-8' codec can't decode byte 0x8b in position 1: invalid start byte`<br/>
è¿™æ˜¯ç½‘é¡µå¯¹æ•°æ®è¿›è¡Œäº†å‹ç¼©å¤„ç†ï¼Œæˆ‘ä»¬æ— æ³•ç›´æ¥åˆ©ç”¨utf-8è¿›è¡Œè§£ç ï¼Œéœ€è¦å…ˆå¯¹æ•°æ®è¿›è¡Œè§£å‹ç¼©ä¹‹åå†è¿›è¡Œè§£ç æ“ä½œ:
```
req=urllib.request.Request(url="https://www.bilibili.com/BPU2021#/poweruplist",headers=H )
response=urllib.request.urlopen(req)
htmls = response.read()
buff = BytesIO(htmls)
res= gzip.GzipFile(fileobj=buff)
text=res.read().decode('UTF-8')
```
<br/>
**`urllib.request.Request()`**ï¼šç”¨æ¥å°è£…è®¿é—®è¯·æ±‚ï¼Œå‚æ•°ä¸­å¯ä»¥åŒ…å«`url`,`headers`,ä¸»è¦åœ¨headersä¸­å¯¹ç¨‹åºè¿›è¡Œä¼ªè£…ï¼Œå¯ä»¥é€šè¿‡æµè§ˆå™¨çš„logè¯»å–ç”¨æˆ·åœ¨å½“å‰æµè§ˆå™¨çš„ç”»åƒï¼Œå¦‚cookieï¼Œuser-agentç­‰ï¼ŒæŒ‰ç…§è¿™äº›å‚æ•°å¯¹æˆ‘ä»¬çš„ç¨‹åºè¿›è¡Œä¼ªè£…ã€‚

![pic from internet](http://commcheck396.github.io/assets/img/2022_1_19/pic1.jpg)
```
H={
    "cookie":"buvid3=1F5EE0AB-0149-8DC6-9C89-953157CE068260962infoc; _uuid=968BBAAC-39F4-26106-19CE-7ED2432C10FB1062353infoc; buvid_fp=1F5EE0AB-0149-8DC6-9C89-953157CE068260962infoc; CURRENT_FNVAL=2000; blackside_state=1; rpdid=|(JukYmJul~0J'uYRuR~JRRJ; sid=bmzaj1dm; innersign=0; fingerprint=5b5c948ff52bc6becc5f720b86468b1d; buvid_fp_plain=undefined; b_lsid=F2CF1A10F_17E6BAD066C; PVID=6; i-wanna-go-back=1; b_ut=8",
    "accept":"text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9",
    "accept-encoding":"gzip, deflate, br",
    "accept-language":"en-US,en;q=0.9",
    "cache-control":"max-age=0",
    "sec-ch-ua-platform": '"Windows"',
    "sec-fetch-dest": "document",
    "sec-ch-ua": '" Not;A Brand";v="99", "Google Chrome";v="97", "Chromium";v="97"',
    "user-agent":"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/97.0.4692.71 Safari/537.36"
}
```

**urllib**è¿˜æœ‰å¥½å¤šå¾ˆæœ‰è¶£å¾ˆå®ç”¨çš„å‘½ä»¤æ¯”å¦‚`getheaders`ç­‰,ä½†æ˜¯å¯¹äºè¿™ä¸ªåŠŸèƒ½æ²¡ä»€ä¹ˆä½œç”¨ï¼Œæ•…ä¸ä½œè®°å½•äº†ï¼Œéšç”¨éšæŸ¥å§ã€‚~~å…¶å®æ˜¯å†™äº†ä¹Ÿè®°ä¸ä¸‹æ¥ï¼ˆ~~
<br/>
<br/>
### BeautifulSoupåº“çš„ä½œç”¨
BeautifulSoupæ˜¯å¯¹äºurllibåº“åŠŸèƒ½çš„ä¸€ä¸ªå»¶ç”³ï¼Œè¦åœ¨urllibæ“ä½œçš„åŸºç¡€ä¸Šè¿›è¡Œã€‚
åœ¨åˆ©ç”¨urllibæ‹‰å–äº†ç½‘é¡µæºç åï¼Œ ä¾¿å¯ä»¥åˆ©ç”¨BeautifulSoupå¯¹æ•°æ®è¿›è¡Œæ£€ç´¢å’Œç­›é€‰ï¼Œå¯ä»¥æ ¹æ®tagä¸­çš„å±æ€§ç­‰å¯¹æºç è¿›è¡Œåˆ†æï¼Œä¹Ÿå¯ä»¥è¿›è¡Œæ ‘å½¢ç»“æ„éå†ï¼Œä½†æ˜¯å¯¹äºçˆ¬å–ç½‘é¡µç‰¹å¾å†…å®¹ï¼Œè¿˜éœ€è¿›è¡Œæ­£åˆ™æœç´¢ï¼Œæˆ‘ä»¬ä»…éœ€åˆ›å»ºBeautifulSoupå¯¹è±¡ï¼ŒæŒ‰ç…§tagç‰¹å¾å±æ€§å®šä½æ‰€éœ€ä¿¡æ¯æ‰€å¤„çš„ä½ç½®ï¼Œå‰©ä¸‹çš„ï¼Œå°±äº¤ç»™æ­£åˆ™æœç´¢ã€‚
```
    html = askURL(url)  # ä¿å­˜è·å–åˆ°çš„ç½‘é¡µæºç 
    soup = BeautifulSoup(html, "html.parser")  #åˆ›å»ºBeautifulSoup
    for item in soup.find_all('div', class_="item"):  # æŸ¥æ‰¾æ‰€æ‰€æœ‰ç¬¦åˆè¦æ±‚çš„tagï¼Œä¹‹ååˆ©ç”¨æ­£åˆ™æœç´¢åœ¨å…¶ä¸­ç­›é€‰å‡ºæˆ‘ä»¬éœ€è¦çš„ä¿¡æ¯
    ... ...
```
<br/>

### æ­£åˆ™æœç´¢
æ²¡åˆ«å“’ï¼Œè€ƒéªŒæ‰¾è§„å¾‹èƒ½åŠ›çš„æ—¶å€™åˆ°äº†ã€‚å–„ç”¨æµè§ˆå™¨æ§åˆ¶å°çš„å…‰æ ‡æŒ‰é’®ã€‚æœ‰åŠ©äºæ›´å¿«çš„å®šä½ã€‚ç»™å‡ ä¸ªä¾‹å­ï¼Œå†ç»™å¼ å‚è€ƒè¡¨ï¼Œéšç”¨éšæŸ¥å§ï¼ŒæŒºç®€å•çš„ä¸œè¥¿ã€‚~~è¿™ä¸æ˜¯å’Œofficeä¸€æ ·å—?~~<br/>[ç»™ä¸ªæ­£åˆ™è¡¨è¾¾çš„å‚è€ƒ](https://blog.csdn.net/baidu_33440774/article/details/82015673?ops_request_misc=%257B%2522request%255Fid%2522%253A%2522164258411516780366532108%2522%252C%2522scm%2522%253A%252220140713.130102334.pc%255Fall.%2522%257D&request_id=164258411516780366532108&biz_id=0&utm_medium=distribute.pc_search_result.none-task-blog-2~all~first_rank_ecpm_v1~rank_v31_ecpm-1-82015673.pc_search_result_cache&utm_term=%E6%AD%A3%E5%88%99%E8%A1%A8%E8%BE%BE%E5%BC%8F%E8%AF%AD%E6%B3%95&spm=1018.2226.3001.4187)
```
findLink = re.compile(r'<a href="(.*?)">')  # åˆ›å»ºæ­£åˆ™è¡¨è¾¾å¼å¯¹è±¡ï¼Œè¾“å‡ºæ‹¬å·é‡Œçš„æ•°æ®ã€‚
findImgSrc = re.compile(r'<img.*src="(.*?)"', re.S)  #re.Sçš„ä½œç”¨ï¼šå¿½ç•¥æ¢è¡Œç¬¦ï¼Œé˜²æ­¢å› ä¸º.ä¸åŒ…æ‹¬æ¢è¡Œç¬¦ï¼Œé˜²æ­¢åœ¨å­—ç¬¦ä¸²ä¸­å‡ºç°æ¢è¡Œç¬¦é€ æˆé”™è¯¯çš„æƒ…å†µã€‚
findTitle = re.compile(r'<span class="title">(.*)</span>')  #rçš„ä½œç”¨ï¼šé˜²æ­¢ç”Ÿæˆè½¬ä¹‰å­—ç¬¦
findRating = re.compile(r'<span class="rating_num" property="v:average">(.*)</span>')
```




ç„¶åå°±å¯ä»¥åˆ©ç”¨findallåœ¨å·²åˆ›å»ºå¥½çš„BeautifulSoupå¯¹è±¡ä¸­è¿›è¡Œç­›é€‰äº†ã€‚
```
for item in soup.find_all('div', class_="item"):  # æŸ¥æ‰¾ç¬¦åˆè¦æ±‚çš„å­—ç¬¦ä¸²
    data = []  # ä¿å­˜ä¸€éƒ¨ç”µå½±æ‰€æœ‰ä¿¡æ¯
    item = str(item)
    link = re.findall(findLink, item)[0]  # é€šè¿‡æ­£åˆ™è¡¨è¾¾å¼æŸ¥æ‰¾
    data.append(link)
    imgSrc = re.findall(findImgSrc, item)[0]
    data.append(imgSrc)
    titles = re.findall(findTitle, item)
    if (len(titles) == 2):
        ctitle = titles[0]
        data.append(ctitle)
        otitle = titles[1].replace("/", "")  #æ¶ˆé™¤è½¬ä¹‰å­—ç¬¦
        data.append(otitle)
    else:
        data.append(titles[0])
        data.append(' ')
    rating = re.findall(findRating, item)[0]
    data.append(rating)
```
## ***EZ!***

<br/>
### xlwtåº“çš„ä½œç”¨
ä¿å­˜åˆ°excelè¡¨ä¸­ï¼Œä¸€çœ‹å°±æ‡‚ï¼Œçœ‹æ³¨é‡Šå§ï¼Œè¿™ä¸œè¥¿ä¹Ÿæ²¡å•¥èŠ±æ ·ã€‚

```
def saveData(savepath):
    savepath="test.xls"
    book = xlwt.Workbook(encoding="utf-8",style_compression=0) #åˆ›å»ºworkbookå¯¹è±¡
    sheet = book.add_sheet('sheet_test', cell_overwrite_ok=True) #åˆ›å»ºå·¥ä½œè¡¨
    col = ("ç”µå½±è¯¦æƒ…é“¾æ¥","å›¾ç‰‡é“¾æ¥","å½±ç‰‡ä¸­æ–‡å","å½±ç‰‡å¤–å›½å","è¯„åˆ†")
    for i in range(0,5):
        sheet.write(0,i,col[i])  #åˆ—å
    for i in range(0,250):
        data = datalist[i]
        for j in range(0,8):
            sheet.write(i+1,j,data[j])  #æ•°æ®
    book.save(savepath) #ä¿å­˜
```

<br/>
åŠ ä¸€ä¸ªmainå‡½æ•°ï¼Œå¼‚æ­¥è¿›è¡Œæ•°æ®æ‹‰å–ï¼ˆurllibï¼‰ï¼Œæ•°æ®å¤„ç†ï¼ˆBeautifulSoupï¼Œæ­£åˆ™æå–ï¼‰ï¼Œæ•°æ®ä¿å­˜ï¼ˆxlwtï¼‰ï¼Œå³å¯å¾—åˆ°ä¸€å¼ çˆ¬å–åˆ°çš„æ•°æ®çš„excelè¡¨ã€‚

![pic from internet](http://commcheck396.github.io/assets/img/2022_1_19/pic4.png)

<br/>
å­¦åˆ°è¿™æˆ‘å…´å†²å†²åœ°æ‰“å¼€äº†Bilibiliï¼Œå‡†å¤‡çˆ¬ç™¾å¤§Upï¼Œä¸ç®¡æˆ‘æ€ä¹ˆä¿®æ”¹æˆ‘çš„ä»£ç ï¼Œæˆ‘çˆ¬å–åˆ°çš„ç½‘é¡µæºä»£ç æ€»æ˜¯å’Œæˆ‘åœ¨æ§åˆ¶å°ä¸­çœ‹åˆ°çš„elementä¸åŒã€‚

![pic from internet](http://commcheck396.github.io/assets/img/2022_1_19/pic2.jpg)

å¯„ï¼ŒBilibiliçš„æ•°æ®æ˜¯å¼‚æ­¥åŠ è½½çš„ã€‚~~tnndï¼Œå’Œæˆ‘ç©é˜´çš„æ˜¯å§ã€‚~~è¿™ç¯‡åšå®¢çš„å†…å®¹ä»…ä½¿ç”¨äºé™æ€ç½‘é¡µï¼Œå³ä¸é€šè¿‡jsåŠ¨æ€åŠ è½½å…ƒç´ çš„ï¼Œå³é”®æŸ¥çœ‹æºä»£ç ä¸æ§åˆ¶å°å…ƒç´ ç›¸åŒçš„ç½‘é¡µã€‚å…³äºåŠ¨æ€ç½‘é¡µçš„çˆ¬å–ï¼Œç•™åˆ°[ä¸‹ä¸€ç¯‡åšå®¢](https://commcheck396.github.io/2022/01/20/dynamic.html)å§ã€‚