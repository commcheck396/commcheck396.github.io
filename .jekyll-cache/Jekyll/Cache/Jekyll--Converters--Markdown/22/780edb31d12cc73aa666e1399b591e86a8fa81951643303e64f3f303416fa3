I"‹˜<h1 id="ä¸èƒ½å†æ‹–äº†">ä¸èƒ½å†æ‹–äº†</h1>

<blockquote>
  <p>Pythorchï¼Œè½®å­åº—</p>
</blockquote>

<p><a href="https://pytorch.org/docs/stable/torch.html">Pytorchå¸¸è§è¿ç®—</a></p>

<p><br /></p>

<h2 id="mostly-used">Mostly Used</h2>

<p>Numpyå‘Torchçš„è½¬åŒ–
<code class="language-plaintext highlighter-rouge">torch_data = torch.from_numpy(np_data)</code></p>

<p><br /></p>

<p>Torchçš„çŸ©é˜µä¹˜æ³•</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="n">torch</span><span class="p">.</span><span class="n">mm</span><span class="p">(</span><span class="n">tensor</span><span class="p">,</span> <span class="n">tensor</span><span class="p">)</span>
<span class="c1"># 'mm' stands for 'matrix multiply'
# æ³¨æ„æ­¤å¤„ä¸Numpyçš„åŒºåˆ«ï¼Œä¸èƒ½ç›´æ¥åˆ©ç”¨.dot()è¿›è¡Œè¿ç®— 
</span>
</code></pre></div></div>

<p><br /></p>

<p>Trochçš„æ•°å­¦è¿ç®—è§„åˆ™å‡ ä¹ä¸Numpyä¸€è‡´ï¼Œ<a href="https://pytorch.org/docs/stable/torch.html">è¯·å‚è€ƒ</a></p>

<p><br /></p>

<p>Torchä¸­ï¼Œè‹¥è¦è¿›è¡Œåå‘ä¼ æ’­ï¼Œéœ€è¦åˆ©ç”¨variableè¿›è¡Œè¿ç®—ï¼Œvariableå¯ä»¥ä¸€æ¬¡æ€§å°†æ‰€æœ‰ä¿®æ”¹å¹…åº¦ (æ¢¯åº¦) éƒ½è®¡ç®—å‡ºæ¥, è€Œtensorå°±æ²¡æœ‰è¿™ä¸ªèƒ½åŠ›ã€‚<br />
ä½†variableä¸­çš„æ•°æ®éœ€è¦tensorç±»å‹å¯¼å…¥ï¼š</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">tensor</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="n">FloatTensor</span><span class="p">([[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">],[</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">]])</span>
<span class="c1"># requires_gradæ˜¯å‚ä¸å‚ä¸è¯¯å·®åå‘ä¼ æ’­, è¦ä¸è¦è®¡ç®—æ¢¯åº¦
</span><span class="n">variable</span> <span class="o">=</span> <span class="n">Variable</span><span class="p">(</span><span class="n">tensor</span><span class="p">,</span> <span class="n">requires_grad</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
</code></pre></div></div>

<p>å‡ç»´</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">x</span><span class="o">=</span><span class="n">torch</span><span class="p">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</code></pre></div></div>

<h2 id="æ¿€åŠ±å‡½æ•°">æ¿€åŠ±å‡½æ•°</h2>

<p>Torch ä¸­çš„æ¿€åŠ±å‡½æ•°æœ‰å¾ˆå¤š, ä¸è¿‡æˆ‘ä»¬å¹³æ—¶è¦ç”¨åˆ°çš„å°±è¿™å‡ ä¸ªï¼š <strong><code class="language-plaintext highlighter-rouge">relu</code></strong>, <code class="language-plaintext highlighter-rouge">sigmoid</code>, <code class="language-plaintext highlighter-rouge">tanh</code>, <code class="language-plaintext highlighter-rouge">softplus</code>ã€‚ 
å¦‚ä½•åˆ©ç”¨æ¿€åŠ±å‡½æ•°:</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># following are popular activation functions
</span><span class="n">y_relu</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="n">relu</span><span class="p">(</span><span class="n">x</span><span class="p">).</span><span class="n">numpy</span><span class="p">()</span>
<span class="n">y_sigmoid</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="n">sigmoid</span><span class="p">(</span><span class="n">x</span><span class="p">).</span><span class="n">numpy</span><span class="p">()</span>
<span class="n">y_tanh</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="n">tanh</span><span class="p">(</span><span class="n">x</span><span class="p">).</span><span class="n">numpy</span><span class="p">()</span>
<span class="n">y_softplus</span> <span class="o">=</span> <span class="n">F</span><span class="p">.</span><span class="n">softplus</span><span class="p">(</span><span class="n">x</span><span class="p">).</span><span class="n">numpy</span><span class="p">()</span> <span class="c1"># there's no softplus in torch
</span></code></pre></div></div>

<h2 id="ç¥ç»ç½‘ç»œçš„æ­å»ºä¸è®­ç»ƒ">ç¥ç»ç½‘ç»œçš„æ­å»ºä¸è®­ç»ƒ</h2>

<h3 id="æ™®é€šæ­å»ºæ–¹æ³•">æ™®é€šæ­å»ºæ–¹æ³•ï¼š</h3>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">Net</span><span class="p">(</span><span class="n">torch</span><span class="p">.</span><span class="n">nn</span><span class="p">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n_feature</span><span class="p">,</span> <span class="n">n_hidden</span><span class="p">,</span> <span class="n">n_output</span><span class="p">):</span> <span class="c1"># åˆ†åˆ«ä»£è¡¨è¾“å…¥ï¼Œè¯¥å±‚ç¥ç»å…ƒä¸ªæ•°ï¼Œè¾“å‡º
</span>        <span class="nb">super</span><span class="p">(</span><span class="n">Net</span><span class="p">,</span> <span class="bp">self</span><span class="p">).</span><span class="n">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">hidden</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="n">nn</span><span class="p">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">n_feature</span><span class="p">,</span> <span class="n">n_hidden</span><span class="p">)</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">predict</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="n">nn</span><span class="p">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">n_hidden</span><span class="p">,</span> <span class="n">n_output</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">F</span><span class="p">.</span><span class="n">relu</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">hidden</span><span class="p">(</span><span class="n">x</span><span class="p">))</span> <span class="c1"># åˆ©ç”¨reluæ¿€åŠ±å‡½æ•°
</span>        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">predict</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">x</span>

<span class="n">net</span> <span class="o">=</span> <span class="n">Net</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="c1"># æ­å»ºå«æœ‰ä¸€å±‚åä¸ªhiddenç¥ç»å…ƒçš„ç¥ç»ç½‘ç»œ
</span>
<span class="c1"># ç»“æ„ï¼š
# Net (
#   (hidden): Linear (1 -&gt; 10)
#   (predict): Linear (10 -&gt; 1)
# )
</span>
</code></pre></div></div>

<p><del>ğŸ¶éƒ½ä¸ç”¨ï¼Œæœ‰è½®å­è¿˜ä¸ç”¨ï¼Ÿ</del><br />
 <br /></p>

<h3 id="æˆ‘tmç›´æ¥å¿«é€Ÿæ­å»º"><del>æˆ‘tmç›´æ¥</del>å¿«é€Ÿæ­å»º</h3>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">net</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="n">nn</span><span class="p">.</span><span class="n">Sequential</span><span class="p">(</span>
    <span class="n">torch</span><span class="p">.</span><span class="n">nn</span><span class="p">.</span><span class="n">Linear</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">10</span><span class="p">),</span>
    <span class="n">torch</span><span class="p">.</span><span class="n">nn</span><span class="p">.</span><span class="n">ReLU</span><span class="p">(),</span> <span class="c1"># æ³¨æ„è¦å¤§å†™ï¼Œè¿™é‡Œçš„ReLUæ˜¯ä¸€ä¸ªclass
</span>    <span class="n">torch</span><span class="p">.</span><span class="n">nn</span><span class="p">.</span><span class="n">Linear</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="p">)</span>

<span class="c1"># ç»“æ„ï¼š
# Sequential (
#   (0): Linear (1 -&gt; 10)
#   (1): ReLU ()
#   (2): Linear (10 -&gt; 1)
# )
</span></code></pre></div></div>

<h3 id="è®­ç»ƒæ–¹æ³•">è®­ç»ƒæ–¹æ³•</h3>

<p><img src="http://commcheck396.github.io/blog/assets/img/2022_2_14/contrast.jpg" alt="pic from internet" /></p>

<p><img src="http://commcheck396.github.io/blog/assets/img/2022_2_14/example.png" alt="pic from internet" /></p>
<h4 id="å›å½’æ‹Ÿåˆ">å›å½’æ‹Ÿåˆ</h4>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># optimizer æ˜¯è®­ç»ƒçš„å·¥å…·
</span><span class="n">optimizer</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="n">optim</span><span class="p">.</span><span class="n">SGD</span><span class="p">(</span><span class="n">net</span><span class="p">.</span><span class="n">parameters</span><span class="p">(),</span> <span class="n">lr</span><span class="o">=</span><span class="mf">0.2</span><span class="p">)</span>  <span class="c1"># ä¼ å…¥ net çš„æ‰€æœ‰å‚æ•°, learning rate
</span><span class="n">loss_func</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="n">nn</span><span class="p">.</span><span class="n">MSELoss</span><span class="p">()</span>      <span class="c1"># é¢„æµ‹å€¼å’ŒçœŸå®å€¼çš„è¯¯å·®è®¡ç®—å…¬å¼ (å‡æ–¹å·®)
</span>
<span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">100</span><span class="p">):</span>
    <span class="n">prediction</span> <span class="o">=</span> <span class="n">net</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>     <span class="c1"># å–‚ç»™ net è®­ç»ƒæ•°æ® x, è¾“å‡ºé¢„æµ‹å€¼
</span>    <span class="n">loss</span> <span class="o">=</span> <span class="n">loss_func</span><span class="p">(</span><span class="n">prediction</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>     <span class="c1"># è®¡ç®—ä¸¤è€…çš„è¯¯å·®,predictionè¦åœ¨å‰
</span>    <span class="n">optimizer</span><span class="p">.</span><span class="n">zero_grad</span><span class="p">()</span>   <span class="c1"># æ¸…ç©ºä¸Šä¸€æ­¥çš„æ®‹ä½™æ›´æ–°å‚æ•°å€¼
</span>    <span class="n">loss</span><span class="p">.</span><span class="n">backward</span><span class="p">()</span>         <span class="c1"># è¯¯å·®åå‘ä¼ æ’­, è®¡ç®—å‚æ•°æ›´æ–°å€¼
</span>    <span class="n">optimizer</span><span class="p">.</span><span class="n">step</span><span class="p">()</span>        <span class="c1"># å°†å‚æ•°æ›´æ–°å€¼æ–½åŠ åˆ° net çš„ parameters ä¸Š
</span></code></pre></div></div>

<h4 id="åŒºåˆ†ç±»å‹">åŒºåˆ†ç±»å‹</h4>
<p>åˆ©ç”¨one-hot vectorè¾“å‡ºï¼Œå¹¶åˆ©ç”¨softmaxè¿›è¡Œnormalizationï¼Œä½†åœ¨Pytorchä¸­softmaxå·²ç»è¢«æ•´åˆåœ¨CrossEntropyä¸­ï¼Œæ•…ä¸å¿…å•ç‹¬è¿›è¡Œsoftmaxæ“ä½œ
<img src="http://commcheck396.github.io/blog/assets/img/2022_2_14/ont-hot.png" alt="pic from internet" /></p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">net</span> <span class="o">=</span> <span class="n">Net</span><span class="p">(</span><span class="n">n_feature</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">n_hidden</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">n_output</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span> <span class="c1"># å‡ ä¸ªç±»åˆ«å°±å‡ ä¸ª output
</span>
<span class="c1"># optimizer æ˜¯è®­ç»ƒçš„å·¥å…·
</span><span class="n">optimizer</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="n">optim</span><span class="p">.</span><span class="n">SGD</span><span class="p">(</span><span class="n">net</span><span class="p">.</span><span class="n">parameters</span><span class="p">(),</span> <span class="n">lr</span><span class="o">=</span><span class="mf">0.02</span><span class="p">)</span>  <span class="c1"># ä¼ å…¥ net çš„æ‰€æœ‰å‚æ•°,learning rate
</span><span class="n">loss_func</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="n">nn</span><span class="p">.</span><span class="n">CrossEntropyLoss</span><span class="p">()</span> 
<span class="c1"># æ³¨æ„loss functionçš„æ”¹å˜ï¼Œæ­¤æ—¶çš„è¾“å‡ºæ˜¯äºŒç»´æ•°æ®ï¼Œæ¯”å¦‚[0.2,0.8]ï¼Œä»£è¡¨è¯¥ç‚¹å±äºç¬¬ä¸€ç±»åˆ«çš„æ¦‚ç‡ä¸º0.2ï¼Œå±äºç¬¬äºŒç±»åˆ«çš„æ¦‚ç‡ä¸º0.8ï¼Œæ‰€ä»¥ä¸èƒ½åˆ©ç”¨ä¸regressionç›¸åŒçš„loss functionï¼Œéœ€è¦ç”¨è¿™ä¸ª
</span>

<span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">100</span><span class="p">):</span>
    <span class="n">out</span> <span class="o">=</span> <span class="n">net</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>     <span class="c1"># å–‚ç»™ net è®­ç»ƒæ•°æ® x, è¾“å‡ºåˆ†æå€¼
</span>    <span class="n">loss</span> <span class="o">=</span> <span class="n">loss_func</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>     <span class="c1"># è®¡ç®—ä¸¤è€…çš„è¯¯å·®
</span>    <span class="n">optimizer</span><span class="p">.</span><span class="n">zero_grad</span><span class="p">()</span>   <span class="c1"># æ¸…ç©ºä¸Šä¸€æ­¥çš„æ®‹ä½™æ›´æ–°å‚æ•°å€¼
</span>    <span class="n">loss</span><span class="p">.</span><span class="n">backward</span><span class="p">()</span>         <span class="c1"># è¯¯å·®åå‘ä¼ æ’­, è®¡ç®—å‚æ•°æ›´æ–°å€¼
</span>    <span class="n">optimizer</span><span class="p">.</span><span class="n">step</span><span class="p">()</span>        <span class="c1"># å°†å‚æ•°æ›´æ–°å€¼æ–½åŠ åˆ° net çš„ parameters ä¸Š
</span>
</code></pre></div></div>

<h2 id="ç¥ç»ç½‘ç»œçš„ä¿å­˜ä¸æå–">ç¥ç»ç½‘ç»œçš„ä¿å­˜ä¸æå–</h2>

<h3 id="save">save</h3>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">torch</span><span class="p">.</span><span class="n">save</span><span class="p">(</span><span class="n">net1</span><span class="p">,</span> <span class="s">'net.pkl'</span><span class="p">)</span>  <span class="c1"># ä¿å­˜æ•´ä¸ªç½‘ç»œ
</span><span class="n">torch</span><span class="p">.</span><span class="n">save</span><span class="p">(</span><span class="n">net1</span><span class="p">.</span><span class="n">state_dict</span><span class="p">(),</span> <span class="s">'net_params.pkl'</span><span class="p">)</span>   <span class="c1"># åªä¿å­˜ç½‘ç»œä¸­çš„å‚æ•° (é€Ÿåº¦å¿«, å å†…å­˜å°‘)
</span></code></pre></div></div>

<h3 id="load">load</h3>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># æå–æ•´ä¸ªç½‘ç»œ
</span>
<span class="n">net2</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="n">load</span><span class="p">(</span><span class="s">'net.pkl'</span><span class="p">)</span> <span class="c1"># æå–ç½‘ç»œ
</span><span class="n">prediction</span> <span class="o">=</span> <span class="n">net2</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="c1"># ä½¿ç”¨ç½‘ç»œ
</span>

<span class="c1"># æå–ç½‘ç»œå‚æ•°
</span>
<span class="c1"># éœ€è¦æ–°å»º net3ï¼Œå†å°†æå–çš„å‚æ•°å¯¼å…¥è¯¥ç½‘ç»œä¸­
</span><span class="n">net3</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="n">nn</span><span class="p">.</span><span class="n">Sequential</span><span class="p">(</span>
    <span class="n">torch</span><span class="p">.</span><span class="n">nn</span><span class="p">.</span><span class="n">Linear</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">10</span><span class="p">),</span>
    <span class="n">torch</span><span class="p">.</span><span class="n">nn</span><span class="p">.</span><span class="n">ReLU</span><span class="p">(),</span>
    <span class="n">torch</span><span class="p">.</span><span class="n">nn</span><span class="p">.</span><span class="n">Linear</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="p">)</span>

<span class="n">net3</span><span class="p">.</span><span class="n">load_state_dict</span><span class="p">(</span><span class="n">torch</span><span class="p">.</span><span class="n">load</span><span class="p">(</span><span class="s">'net_params.pkl'</span><span class="p">))</span> <span class="c1"># å°†ä¿å­˜çš„å‚æ•°å¤åˆ¶åˆ° net3
</span><span class="n">prediction</span> <span class="o">=</span> <span class="n">net3</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="c1"># ä½¿ç”¨ç½‘ç»œ
</span> 
</code></pre></div></div>

<h2 id="æ‰¹è®­ç»ƒ">æ‰¹è®­ç»ƒ</h2>
<p>éœ€è¦å¼•å…¥library<code class="language-plaintext highlighter-rouge">import torch.utils.data as Data</code>å®ç°<br />
æƒ³è¦åˆ†batchï¼Œå¿…ç„¶è¦åˆ©ç”¨æ‰¹å¤„ç†ï¼Œç®€ä¾‹å¦‚ä¸‹</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># ç®€ç®€å•å•ä¸¤ç»„æ•°æ®
</span><span class="n">x</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>       <span class="c1"># x data (torch tensor)
</span><span class="n">y</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>       <span class="c1"># y data (torch tensor)
</span>
<span class="c1"># å…ˆè½¬æ¢æˆ torch èƒ½è¯†åˆ«çš„ Dataset
</span><span class="n">torch_dataset</span> <span class="o">=</span> <span class="n">Data</span><span class="p">.</span><span class="n">TensorDataset</span><span class="p">(</span><span class="n">data_tensor</span><span class="o">=</span><span class="n">x</span><span class="p">,</span> <span class="n">target_tensor</span><span class="o">=</span><span class="n">y</span><span class="p">)</span>

<span class="c1"># æŠŠ dataset æ”¾å…¥ DataLoader
</span><span class="n">loader</span> <span class="o">=</span> <span class="n">Data</span><span class="p">.</span><span class="n">DataLoader</span><span class="p">(</span>
    <span class="n">dataset</span><span class="o">=</span><span class="n">torch_dataset</span><span class="p">,</span>      <span class="c1"># torch TensorDataset format
</span>    <span class="n">batch_size</span><span class="o">=</span><span class="n">BATCH_SIZE</span><span class="p">,</span>      <span class="c1"># mini batch size
</span>    <span class="n">shuffle</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>               <span class="c1"># è¦ä¸è¦æ‰“ä¹±æ•°æ® (æ‰“ä¹±æ¯”è¾ƒå¥½)
</span>    <span class="n">num_workers</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>              <span class="c1"># å¤šçº¿ç¨‹æ¥è¯»æ•°æ®
</span><span class="p">)</span>

<span class="k">for</span> <span class="n">epoch</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>   <span class="c1"># è®­ç»ƒæ‰€æœ‰æ•°æ® 3 æ¬¡
</span>    <span class="k">for</span> <span class="n">step</span><span class="p">,</span> <span class="p">(</span><span class="n">batch_x</span><span class="p">,</span> <span class="n">batch_y</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">loader</span><span class="p">):</span>  <span class="c1"># æ¯ä¸€æ­¥ loader é‡Šæ”¾ä¸€å°æ‰¹æ•°æ®ç”¨æ¥å­¦ä¹ 
</span>        <span class="c1"># training...
</span></code></pre></div></div>
<p>è‹¥all_setä¸æ˜¯batchçš„æ•´æ•°å€ä¹Ÿæ— å¦¨ï¼Œloaderä¼šåœ¨æœ€åä¸€æ¬¡è®­ç»ƒä¸­å°†æ‰€æœ‰çš„æ•°æ®å…¨éƒ¨æ”¾å…¥ä¸€ä¸ªbatchä¸­</p>
<h2 id="optimizer">Optimizer</h2>

<p><del>æ— è„‘Adamå°±å¯ä»¥äº†</del>
<img src="http://commcheck396.github.io/blog/assets/img/2022_2_14/adam.png" alt="pic from internet" />
å‡ ç§å¸¸è§çš„ä¼˜åŒ–å™¨ï¼š<code class="language-plaintext highlighter-rouge">SGD</code>, <code class="language-plaintext highlighter-rouge">Momentum</code>, <code class="language-plaintext highlighter-rouge">RMSprop</code>, <code class="language-plaintext highlighter-rouge">Adam</code><br />
ä½¿ç”¨æ–¹æ³•ï¼š</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># different optimizers
</span><span class="n">opt_SGD</span>         <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="n">optim</span><span class="p">.</span><span class="n">SGD</span><span class="p">(</span><span class="n">net_SGD</span><span class="p">.</span><span class="n">parameters</span><span class="p">(),</span> <span class="n">lr</span><span class="o">=</span><span class="n">LR</span><span class="p">)</span>
<span class="n">opt_Momentum</span>    <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="n">optim</span><span class="p">.</span><span class="n">SGD</span><span class="p">(</span><span class="n">net_Momentum</span><span class="p">.</span><span class="n">parameters</span><span class="p">(),</span> <span class="n">lr</span><span class="o">=</span><span class="n">LR</span><span class="p">,</span> <span class="n">momentum</span><span class="o">=</span><span class="mf">0.8</span><span class="p">)</span> <span class="c1"># æ³¨æ„momentumå°±æ˜¯SGDçš„å¥—å£³
</span><span class="n">opt_RMSprop</span>     <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="n">optim</span><span class="p">.</span><span class="n">RMSprop</span><span class="p">(</span><span class="n">net_RMSprop</span><span class="p">.</span><span class="n">parameters</span><span class="p">(),</span> <span class="n">lr</span><span class="o">=</span><span class="n">LR</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.9</span><span class="p">)</span>
<span class="n">opt_Adam</span>        <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="n">optim</span><span class="p">.</span><span class="n">Adam</span><span class="p">(</span><span class="n">net_Adam</span><span class="p">.</span><span class="n">parameters</span><span class="p">(),</span> <span class="n">lr</span><span class="o">=</span><span class="n">LR</span><span class="p">,</span> <span class="n">betas</span><span class="o">=</span><span class="p">(</span><span class="mf">0.9</span><span class="p">,</span> <span class="mf">0.99</span><span class="p">))</span>
<span class="c1"># é¦–é€‰åä¸¤ä¸ªOptimizerï¼Œæ•ˆæœè¾ƒä½³
</span></code></pre></div></div>

<h2 id="åˆ©ç”¨pytorchæ­å»ºcnnç½‘ç»œ">åˆ©ç”¨Pytorchæ­å»ºCNNç½‘ç»œ</h2>

<p><strong>ä»¥MNISTä»»åŠ¡ä¸ºä¾‹</strong></p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># å¼•å…¥å¦‚ä¸‹library
</span><span class="kn">import</span> <span class="nn">torch.nn</span> <span class="k">as</span> <span class="n">nn</span>
<span class="kn">import</span> <span class="nn">torch.utils.data</span> <span class="k">as</span> <span class="n">Data</span>
<span class="kn">import</span> <span class="nn">torchvision</span>

<span class="c1"># ç»™å®šHyper Parameters
</span><span class="n">EPOCH</span> <span class="o">=</span> <span class="mi">1</span>               <span class="c1"># train the training data n times, to save time, we just train 1 epoch
</span><span class="n">BATCH_SIZE</span> <span class="o">=</span> <span class="mi">50</span>
<span class="n">LR</span> <span class="o">=</span> <span class="mf">0.001</span>              <span class="c1"># learning rate
</span></code></pre></div></div>
<h3 id="æ•°æ®çš„è®­ç»ƒä¸æµ‹è¯•">æ•°æ®çš„è®­ç»ƒä¸æµ‹è¯•</h3>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># è®­ç»ƒsetçš„åˆå§‹åŒ–
</span><span class="n">train_data</span> <span class="o">=</span> <span class="n">torchvision</span><span class="p">.</span><span class="n">datasets</span><span class="p">.</span><span class="n">MNIST</span><span class="p">(</span>
    <span class="n">root</span><span class="o">=</span><span class="s">'./mnist/'</span><span class="p">,</span>
    <span class="n">train</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>                                     <span class="c1"># this is training data
</span>    <span class="n">transform</span><span class="o">=</span><span class="n">torchvision</span><span class="p">.</span><span class="n">transforms</span><span class="p">.</span><span class="n">ToTensor</span><span class="p">(),</span>    <span class="c1"># Converts a PIL.Image or numpy.ndarray to
</span>                                                    <span class="c1"># torch.FloatTensor of shape (C x H x W) and normalize in the range [0.0, 1.0]
</span>    <span class="n">download</span><span class="o">=</span><span class="n">DOWNLOAD_MNIST</span><span class="p">,</span>                        <span class="c1"># downloaded or not
</span><span class="p">)</span>
<span class="n">train_loader</span> <span class="o">=</span> <span class="n">Data</span><span class="p">.</span><span class="n">DataLoader</span><span class="p">(</span><span class="n">dataset</span><span class="o">=</span><span class="n">train_data</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">BATCH_SIZE</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span> <span class="c1"># åŠ è½½training set
</span>

<span class="c1"># pick 2000 samples to speed up testing
</span><span class="n">test_data</span> <span class="o">=</span> <span class="n">torchvision</span><span class="p">.</span><span class="n">datasets</span><span class="p">.</span><span class="n">MNIST</span><span class="p">(</span><span class="n">root</span><span class="o">=</span><span class="s">'./mnist/'</span><span class="p">,</span> <span class="n">train</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
<span class="n">test_x</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="n">test_data</span><span class="p">.</span><span class="n">test_data</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">).</span><span class="nb">type</span><span class="p">(</span><span class="n">torch</span><span class="p">.</span><span class="n">FloatTensor</span><span class="p">)[:</span><span class="mi">2000</span><span class="p">]</span><span class="o">/</span><span class="mf">255.</span>   <span class="c1"># ç”±äºä»…ä»…å¯¹train_dataè¿›è¡Œäº†tensorå¤„ç†ï¼ŒåŒæ ·ä¹Ÿéœ€è¦å¯¹test_dataè¿›è¡Œå¤„ç†ï¼Œä½¿å…¶å–å€¼èŒƒå›´åœ¨[0,1]ï¼Œæ‰€ä»¥å¯¹å…¶é™¤255
</span><span class="n">test_y</span> <span class="o">=</span> <span class="n">test_data</span><span class="p">.</span><span class="n">test_labels</span><span class="p">[:</span><span class="mi">2000</span><span class="p">]</span>  <span class="c1"># ä»…å–å‰2000ä¸ªè¿›è¡Œtest
</span>
</code></pre></div></div>

<h3 id="æ­å»ºcnnç½‘ç»œ">æ­å»ºCNNç½‘ç»œ</h3>
<p>CNNåŸºç¡€æ¶æ„å¦‚å›¾æ‰€ç¤º
<img src="http://commcheck396.github.io/blog/assets/img/2022_2_14/CNN.png" alt="pic from internet" />
<img src="http://commcheck396.github.io/blog/assets/img/2022_2_14/filter.jpg" alt="pic from internet" />
paddingçš„æ„ä¹‰ï¼šä¸ºäº†ä½¿ç»è¿‡convçš„å›¾ç‰‡å¤§å°ä¸è¢«å‹ç¼©ï¼Œè®¾ä¸ºâ€˜sameâ€™å³å¯
<img src="http://commcheck396.github.io/blog/assets/img/2022_2_14/padding.gif" alt="pic from internet" />
Pytorchå®ç°å¦‚ä¸‹</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">CNN</span><span class="p">(</span><span class="n">nn</span><span class="p">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">CNN</span><span class="p">,</span> <span class="bp">self</span><span class="p">).</span><span class="n">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">conv1</span> <span class="o">=</span> <span class="n">nn</span><span class="p">.</span><span class="n">Sequential</span><span class="p">(</span>  <span class="c1"># input shape (1, 28, 28)
</span>            <span class="n">nn</span><span class="p">.</span><span class="n">Conv2d</span><span class="p">(</span>
                <span class="n">in_channels</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>      <span class="c1"># input height
</span>                <span class="n">out_channels</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span>    <span class="c1"># filterä¸ªæ•°
</span>                <span class="n">kernel_size</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>      <span class="c1"># filter size
</span>                <span class="n">stride</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>           <span class="c1"># filter movement/stepï¼Œæ­¥é•¿
</span>                <span class="n">padding</span><span class="o">=</span><span class="s">'same'</span><span class="p">,</span>      <span class="c1"># å¦‚æœæƒ³è¦ con2d å‡ºæ¥çš„å›¾ç‰‡é•¿å®½æ²¡æœ‰å˜åŒ–, padding=(kernel_size-1)/2 å½“ stride=1  
</span>            <span class="p">),</span>      <span class="c1"># output shape (16, 28, 28)
</span>            <span class="n">nn</span><span class="p">.</span><span class="n">ReLU</span><span class="p">(),</span>    <span class="c1"># activation
</span>            <span class="n">nn</span><span class="p">.</span><span class="n">MaxPool2d</span><span class="p">(</span><span class="n">kernel_size</span><span class="o">=</span><span class="mi">2</span><span class="p">),</span>    <span class="c1"># åœ¨ 2x2 ç©ºé—´é‡Œå‘ä¸‹é‡‡æ ·, output shape (16, 14, 14)ï¼Œç”±äºç»å†äº†ä¸€ä¸ªkerne_sizeä¸º2çš„poolingï¼Œé•¿å®½å˜ä¸ºä¹‹å‰çš„ä¸€åŠï¼Œç»è¿‡16ä¸ªfilterï¼Œå˜ä¸º16
</span>        <span class="p">)</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">conv2</span> <span class="o">=</span> <span class="n">nn</span><span class="p">.</span><span class="n">Sequential</span><span class="p">(</span>  <span class="c1"># input shape (16, 14, 14)
</span>            <span class="n">nn</span><span class="p">.</span><span class="n">Conv2d</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s">'same'</span><span class="p">),</span>  <span class="c1"># output shape (32, 14, 14)
</span>            <span class="n">nn</span><span class="p">.</span><span class="n">ReLU</span><span class="p">(),</span>  <span class="c1"># activation
</span>            <span class="n">nn</span><span class="p">.</span><span class="n">MaxPool2d</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span>  <span class="c1"># å†è¿›è¡Œä¸€æ¬¡poolingï¼Œoutput shape (32, 7, 7)
</span>        <span class="p">)</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">out</span> <span class="o">=</span> <span class="n">nn</span><span class="p">.</span><span class="n">Linear</span><span class="p">(</span><span class="mi">32</span> <span class="o">*</span> <span class="mi">7</span> <span class="o">*</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>   <span class="c1"># fully connected layer, output 10 classes
</span>
    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">conv1</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">conv2</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="p">.</span><span class="n">view</span><span class="p">(</span><span class="n">x</span><span class="p">.</span><span class="n">size</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>   <span class="c1"># å±•å¹³å¤šç»´çš„å·ç§¯å›¾æˆ (batch_size, 32 * 7 * 7)  
</span>        <span class="n">output</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">out</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">output</span>

<span class="n">cnn</span> <span class="o">=</span> <span class="n">CNN</span><span class="p">()</span>  <span class="c1"># åˆå§‹åŒ–ç¥ç»ç½‘ç»œ
</span></code></pre></div></div>

<h3 id="è®­ç»ƒè¿‡ç¨‹">è®­ç»ƒè¿‡ç¨‹</h3>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">optimizer</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="n">optim</span><span class="p">.</span><span class="n">Adam</span><span class="p">(</span><span class="n">cnn</span><span class="p">.</span><span class="n">parameters</span><span class="p">(),</span> <span class="n">lr</span><span class="o">=</span><span class="n">LR</span><span class="p">)</span>   <span class="c1"># optimize all cnn parameters
</span><span class="n">loss_func</span> <span class="o">=</span> <span class="n">nn</span><span class="p">.</span><span class="n">CrossEntropyLoss</span><span class="p">()</span>   <span class="c1"># the target label is not one-hotted
</span>
<span class="c1"># training and testing
</span><span class="k">for</span> <span class="n">epoch</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">EPOCH</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">step</span><span class="p">,</span> <span class="p">(</span><span class="n">b_x</span><span class="p">,</span> <span class="n">b_y</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">train_loader</span><span class="p">):</span>   <span class="c1"># åˆ†é… batch data, normalize x when iterate train_loader
</span>        <span class="n">output</span> <span class="o">=</span> <span class="n">cnn</span><span class="p">(</span><span class="n">b_x</span><span class="p">)</span>               <span class="c1"># cnn output
</span>        <span class="n">loss</span> <span class="o">=</span> <span class="n">loss_func</span><span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="n">b_y</span><span class="p">)</span>   <span class="c1"># cross entropy loss
</span>        <span class="n">optimizer</span><span class="p">.</span><span class="n">zero_grad</span><span class="p">()</span>           <span class="c1"># clear gradients for this training step
</span>        <span class="n">loss</span><span class="p">.</span><span class="n">backward</span><span class="p">()</span>                 <span class="c1"># backpropagation, compute gradients
</span>        <span class="n">optimizer</span><span class="p">.</span><span class="n">step</span><span class="p">()</span>                <span class="c1"># apply gradients
</span></code></pre></div></div>

<h3 id="è®­ç»ƒç»“æŸåé¢„æµ‹åä¸ªæ•°å­—çœ‹ä¸€ä¸‹">è®­ç»ƒç»“æŸåé¢„æµ‹åä¸ªæ•°å­—çœ‹ä¸€ä¸‹</h3>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">test_output</span> <span class="o">=</span> <span class="n">cnn</span><span class="p">(</span><span class="n">test_x</span><span class="p">[:</span><span class="mi">10</span><span class="p">])</span>
<span class="n">pred_y</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="nb">max</span><span class="p">(</span><span class="n">test_output</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">1</span><span class="p">].</span><span class="n">data</span><span class="p">.</span><span class="n">numpy</span><span class="p">().</span><span class="n">squeeze</span><span class="p">()</span>
<span class="k">print</span><span class="p">(</span><span class="n">pred_y</span><span class="p">,</span> <span class="s">'prediction number'</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">test_y</span><span class="p">[:</span><span class="mi">10</span><span class="p">].</span><span class="n">numpy</span><span class="p">(),</span> <span class="s">'real number'</span><span class="p">)</span>
</code></pre></div></div>
<p>ç»“æœä¸€èˆ¬éƒ½ä¼šå¾ˆå¯¹ï¼Œæ¯•ç«ŸMINSTä¹Ÿæ²¡ä»€ä¹ˆéš¾åº¦<br />
<del>ä½†æ˜¯ä¸€å°å¥½çš„ç”µè„‘çœŸçš„å¾ˆé‡è¦</del></p>
:ET